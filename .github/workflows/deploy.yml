name: ğŸš€ Deploy CV ATS Builder

on:
  push:
    branches:
      - main
      - master
    # Hanya trigger jika ada perubahan pada file-file penting
    paths:
      - 'src/**'
      - 'gas/**'
      - 'public/**'
      - 'index.html'
      - 'vite.config.*'
      - 'package.json'
      - 'scripts/**'

  # Bisa juga trigger manual dari GitHub UI
  workflow_dispatch:
    inputs:
      deploy_target:
        description: 'Target deploy'
        required: true
        default: 'both'
        type: choice
        options:
          - both
          - gas-only
          - build-only

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 1: Build & Lint Check
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  build:
    name: ğŸ—ï¸ Build & Lint
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“š Install dependencies
        run: npm ci

      - name: ğŸ” Lint check
        run: npm run lint --if-present
        continue-on-error: true

      - name: ğŸ—ï¸ Build production
        run: npm run build
        env:
          # Env vars dari GitHub Secrets
          VITE_GAS_ENDPOINT: ${{ secrets.VITE_GAS_ENDPOINT }}

      - name: ğŸ“‹ Copy build to gas/
        run: node scripts/copy-build.js

      - name: ğŸ“¦ Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: gas-build
          path: gas/
          retention-days: 7

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 2: Deploy ke Google Apps Script via CLASP
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  deploy-gas:
    name: â˜ï¸ Deploy ke Google Apps Script
    runs-on: ubuntu-latest
    needs: build  # Tunggu build selesai dulu

    # Skip jika input manual adalah build-only
    if: |
      github.event.inputs.deploy_target != 'build-only'

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“š Install dependencies
        run: npm ci

      - name: ğŸ”§ Install CLASP globally
        run: npm install -g @google/clasp

      - name: ğŸ”‘ Setup CLASP credentials
        # Simpan CLASPRC_JSON sebagai GitHub Secret
        # Format: isi dari file ~/.clasprc.json setelah kamu login clasp
        run: |
          echo '${{ secrets.CLASPRC_JSON }}' > ~/.clasprc.json
          echo "âœ… CLASP credentials terpasang"

      - name: ğŸ“¥ Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: gas-build
          path: gas/

      - name: ğŸ“¤ CLASP Push ke GAS
        run: |
          echo "ğŸ“¤ Pushing ke Google Apps Script..."
          clasp push --force
          echo "âœ… Push berhasil!"

      - name: ğŸš€ CLASP Deploy (buat versi baru)
        run: |
          DATE=$(date -u +"%Y-%m-%d %H:%M UTC")
          COMMIT="${{ github.sha }}"
          SHORT_COMMIT="${COMMIT:0:7}"
          clasp deploy --description "Auto deploy | $DATE | ${SHORT_COMMIT}"
          echo "âœ… Deployment baru dibuat!"

      - name: ğŸ’¬ Notifikasi sukses
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ… DEPLOY BERHASIL!"
          echo "Branch  : ${{ github.ref_name }}"
          echo "Commit  : ${{ github.sha }}"
          echo "By      : ${{ github.actor }}"
          echo "Time    : $(date -u)"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
