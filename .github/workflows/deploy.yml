name: ğŸš€ Deploy CV ATS Builder

on:
  push:
    branches:
      - main
      - master
    paths:
      - 'src/**'
      - 'gas/**'
      - 'public/**'
      - 'index.html'
      - 'vite.config.*'
      - 'package.json'
      - 'scripts/**'

  workflow_dispatch:
    inputs:
      deploy_target:
        description: 'Target deploy'
        required: true
        default: 'build-only'
        type: choice
        options:
          - build-only
          - gas-only
          - both

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 1: Build & Lint Check
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  build:
    name: ğŸ—ï¸ Build & Lint
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“š Install dependencies
        run: npm ci

      - name: ğŸ—ï¸ Build production
        run: npm run build
        env:
          VITE_GAS_ENDPOINT: ${{ secrets.VITE_GAS_ENDPOINT }}

      - name: ğŸ“‹ Copy build to gas/
        run: node scripts/copy-build.js

      - name: ğŸ“¦ Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: gas-build
          path: gas/
          retention-days: 7

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 2: Deploy ke Google Apps Script via CLASP
  # Hanya jalan jika secret CLASPRC_JSON sudah diset
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  deploy-gas:
    name: â˜ï¸ Deploy ke Google Apps Script
    runs-on: ubuntu-latest
    needs: build

    # Skip jika secret belum diisi atau target build-only
    if: |
      github.event.inputs.deploy_target != 'build-only' &&
      secrets.CLASPRC_JSON != ''

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“š Install dependencies
        run: npm ci

      - name: ğŸ”§ Install CLASP globally
        run: npm install -g @google/clasp

      - name: ğŸ”‘ Validate & Setup CLASP credentials
        env:
          CLASPRC_JSON: ${{ secrets.CLASPRC_JSON }}
        run: |
          # Cek apakah secret sudah diisi
          if [ -z "$CLASPRC_JSON" ]; then
            echo "âš ï¸  Secret CLASPRC_JSON belum diset."
            echo "    Cara setup:"
            echo "    1. Jalankan: node scripts/get-clasp-token.js"
            echo "    2. Copy output JSON"
            echo "    3. Tambahkan ke: Settings â†’ Secrets â†’ CLASPRC_JSON"
            exit 0
          fi

          # Validasi JSON sebelum ditulis
          echo "$CLASPRC_JSON" | node -e "
            let d='';
            process.stdin.on('data',c=>d+=c);
            process.stdin.on('end',()=>{
              try { JSON.parse(d); console.log('âœ… JSON valid'); }
              catch(e) { console.error('âŒ JSON tidak valid:', e.message); process.exit(1); }
            });
          "

          # Tulis ke file credentials
          echo "$CLASPRC_JSON" > ~/.clasprc.json
          echo "âœ… CLASP credentials terpasang"

      - name: ğŸ“¥ Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: gas-build
          path: gas/

      - name: ğŸ“¤ CLASP Push ke GAS
        env:
          CLASPRC_JSON: ${{ secrets.CLASPRC_JSON }}
        run: |
          if [ -z "$CLASPRC_JSON" ]; then
            echo "âš ï¸ Skip: CLASPRC_JSON belum diset. Build saja yang jalan."
            exit 0
          fi
          echo "ğŸ“¤ Pushing ke Google Apps Script..."
          clasp push --force
          echo "âœ… Push berhasil!"

      - name: ğŸš€ CLASP Deploy (buat versi baru)
        env:
          CLASPRC_JSON: ${{ secrets.CLASPRC_JSON }}
        run: |
          if [ -z "$CLASPRC_JSON" ]; then
            echo "âš ï¸ Skip: CLASPRC_JSON belum diset."
            exit 0
          fi
          DATE=$(date -u +"%Y-%m-%d %H:%M UTC")
          SHORT="${{ github.sha }}"
          clasp deploy --description "Auto | ${DATE} | ${SHORT:0:7}" || true
          echo "âœ… Deployment baru dibuat!"

      - name: ğŸ’¬ Summary
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Branch : ${{ github.ref_name }}"
          echo "Commit : ${{ github.sha }}"
          echo "By     : ${{ github.actor }}"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
